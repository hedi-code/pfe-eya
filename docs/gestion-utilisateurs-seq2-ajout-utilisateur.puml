@startuml Séquence 2 - Ajout d'un Utilisateur

actor "Administrateur" as Admin
participant "UsersManagementComponent" as UserMgmt
participant "TestService" as TestSvc
participant "SupabaseService" as Supabase
database "Supabase DB" as DB

title Ajout d'un Utilisateur

Admin -> UserMgmt : Cliquer "Ajouter un utilisateur"
activate UserMgmt
UserMgmt -> UserMgmt : showAddUserModal = true
UserMgmt --> Admin : Afficher modal
deactivate UserMgmt

Admin -> UserMgmt : Remplir formulaire (email, password, nom, rôle)
Admin -> UserMgmt : Cliquer "Créer"
activate UserMgmt

UserMgmt -> TestSvc : createUser(newUser)
activate TestSvc

TestSvc -> Supabase : supabase.auth.admin.createUser()
activate Supabase
Supabase -> DB : Créer utilisateur auth
activate DB
DB --> Supabase : authData.user
deactivate DB
Supabase --> TestSvc : {data, error}
deactivate Supabase

alt Création auth réussie
    TestSvc -> Supabase : supabase.from('profiles').insert()
    activate Supabase
    Supabase -> DB : INSERT INTO profiles
    activate DB
    DB --> Supabase : Confirmation
    deactivate DB
    Supabase --> TestSvc : {error}
    deactivate Supabase

    TestSvc --> UserMgmt : {success: true}
    deactivate TestSvc

    UserMgmt -> UserMgmt : showAddUserModal = false
    UserMgmt -> UserMgmt : Réinitialiser newUser
    UserMgmt -> UserMgmt : fetchUsers()
    UserMgmt --> Admin : Afficher liste mise à jour
else Erreur lors de la création
    TestSvc --> UserMgmt : {error}
    deactivate TestSvc
    UserMgmt -> UserMgmt : console.error(error)
    UserMgmt --> Admin : Afficher erreur
end

deactivate UserMgmt

@enduml
